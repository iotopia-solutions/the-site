{"version":3,"sources":["routes/pages.js"],"names":["index","req","res","readFile","__dirname","err","text","then","extractPosts","addPresentationMeta","convertPostsToHtml","catch","insertHtml","send","pageHtml","JSON","parse","resp","body","posts","length","isLast","reduce","html","post","token","replace"],"mappings":";;;;;;;AAAA;;;;AACA;;AACA;;AACA;;;;;;AAEA;AACA;;AAEO,IAAMA,wBACT,SADSA,KACT,CAACC,GAAD,EAAMC,GAAN;AAAA,SACA,aAAGC,QAAH,CACEC,YAAY,yBADd,EACyC,MADzC,EAEE,UAACC,GAAD,EAAMC,IAAN,EAAe;AACb;AACA,QAAID,GAAJ,EAAS,MAAMA,GAAN;AACT;AACA,kCACGE,IADH,CACQC,YADR,EAEGD,IAFH,CAEQE,mBAFR,EAGGF,IAHH,CAGQG,kBAHR;AAIE;AAJF,KAKGC,KALH,CAKS;AAAA,aAAO,yDAAyDN,GAAzD,GAA+D,KAAtE;AAAA,KALT,EAMGE,IANH,CAMQK,WAAW,wBAAX,EAAqCN,IAArC,CANR,EAOGC,IAPH,CAOQ;AAAA,aAAYL,IAAIW,IAAJ,CAASC,QAAT,CAAZ;AAAA,KAPR;AAQD,GAdH,CADA;AAAA,CADG;;AAmBP;AACA,IAAMN,eACF,SADEA,YACF;AAAA,SAAQO,KAAKC,KAAL,CAAWC,KAAK,CAAL,EAAQC,IAAnB,EAAyBC,KAAjC;AAAA,CADJ;;AAGA;AACA,IAAMV,sBACF,SADEA,mBACF,QAAS;AACT,MAAIU,SAASA,MAAMC,MAAN,GAAe,CAA5B,EAA+B;AAC7BD,UAAMA,MAAMC,MAAN,GAAe,CAArB,EAAwBC,MAAxB,GAAiC,IAAjC;AACD;AACD,SAAOF,KAAP;AACD,CANH;;AAQA;AACA,IAAMT,qBACF,SADEA,kBACF,QAAS;AACT,MAAIS,SAASA,MAAMC,MAAN,GAAe,CAA5B,EAA+B;AAC7B,WAAOD,MAAMG,MAAN,CACL,UAACC,IAAD,EAAOC,IAAP;AAAA,aAAgBD,OAAO,kCAAqB,4BAAaC,IAAb,CAArB,CAAvB;AAAA,KADK,EAEL,EAFK,CAAP;AAID,GALD,MAMK;AACH,WAAO,6BAAP;AACD;AACF,CAXH;;AAaA;AACA;AACA,IAAMZ,aACF,SADEA,UACF,CAACa,KAAD,EAAQnB,IAAR;AAAA,SAAiB;AAAA,WAAQA,KAAKoB,OAAL,CAAaD,KAAb,EAAoBF,IAApB,CAAR;AAAA,GAAjB;AAAA,CADJ","file":"routes/pages.js","sourcesContent":["import fs from 'fs';\nimport { getPosts } from '../blog/wordpressApi';\nimport { renderToStaticMarkup } from 'react-dom/server';\nimport blogsSection from '../blog/blogsSection';\n\n// TODO: read and process the template index file at load time.\n// TODO: Use a React Component to process last blog post and default text (\"<p>no blogs</p>\").\n\nexport const index\n  = (req, res) =>\n    fs.readFile(\n      __dirname + '/../../views/index.html', 'utf8',\n      (err, text) => {\n        // fail hard if we can't read index.html.\n        if (err) throw err;\n        // render blog posts from WP data\n        getPosts()\n          .then(extractPosts)\n          .then(addPresentationMeta)\n          .then(convertPostsToHtml)\n          // Output error into page with details hidden in a comment.\n          .catch(err => '<p>Unable to fetch blog posts at this time.</p><!-- ' + err + '-->')\n          .then(insertHtml('<!-- blogs-go-here -->', text))\n          .then(pageHtml => res.send(pageHtml));\n      }\n    );\n\n// Extract the blog posts json data from the wordpress api response.\nconst extractPosts\n  = resp => JSON.parse(resp[0].body).posts;\n\n// Add metadata for processing the blog post into html.\nconst addPresentationMeta\n  = posts => {\n    if (posts && posts.length > 0) {\n      posts[posts.length - 1].isLast = true;\n    }\n    return posts;\n  };\n\n// Convert the posts json to html.\nconst convertPostsToHtml\n  = posts => {\n    if (posts && posts.length > 0) {\n      return posts.reduce(\n        (html, post) => html + renderToStaticMarkup(blogsSection(post)),\n        ''\n      );\n    }\n    else {\n      return '<p>No blog posts found.</p>';\n    }\n  };\n\n// Insert the blog html into the page html.\n// Splitting the page at a comment is primitive, but works for now.\nconst insertHtml\n  = (token, text) => html => text.replace(token, html);\n"],"sourceRoot":"/Users/john/Code/the-site/es6"}